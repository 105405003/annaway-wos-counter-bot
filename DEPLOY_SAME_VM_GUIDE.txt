==================================================
    åŒä¸€å° VM éƒ¨ç½²ä¸­è‹±æ–‡é›™ç‰ˆæœ¬ - å®Œæ•´æŒ‡å—
==================================================

ğŸ¯ ç›®æ¨™
--------------------------------------------------
åœ¨åŒä¸€å° VM ä¸Šé‹è¡Œå…©å€‹ç¨ç«‹çš„ Discord Botï¼š
- è‹±æ–‡ç‰ˆï¼šä½¿ç”¨ port 8001ï¼Œè·¯å¾‘ /1458/
- ä¸­æ–‡ç‰ˆï¼šä½¿ç”¨ port 8000ï¼Œè·¯å¾‘ /1496/

ğŸ“‚ VM ä¸Šçš„è³‡æ–™å¤¾çµæ§‹
--------------------------------------------------
/home/anna_c/
â”œâ”€â”€ wos-english-refill-bot/     # è‹±æ–‡ç‰ˆå°ˆæ¡ˆè³‡æ–™å¤¾
â”‚   â”œâ”€â”€ bot_refill.py
â”‚   â”œâ”€â”€ .env                    # è‹±æ–‡ç‰ˆè¨­å®šï¼ˆToken, port 8001ï¼‰
â”‚   â”œâ”€â”€ panel/
â”‚   â”‚   â””â”€â”€ frontend/
â”‚   â”‚       â””â”€â”€ dist/           # å»ºç½®å¾Œçš„å‰ç«¯æª”æ¡ˆ
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ wos-chinese-refill-bot/     # ä¸­æ–‡ç‰ˆå°ˆæ¡ˆè³‡æ–™å¤¾
    â”œâ”€â”€ bot_refill.py
    â”œâ”€â”€ .env                    # ä¸­æ–‡ç‰ˆè¨­å®šï¼ˆToken, port 8000ï¼‰
    â”œâ”€â”€ panel/
    â”‚   â””â”€â”€ frontend/
    â”‚       â””â”€â”€ dist/           # å»ºç½®å¾Œçš„å‰ç«¯æª”æ¡ˆ
    â””â”€â”€ ...

/var/www/
â”œâ”€â”€ refill-bot-en/              # è‹±æ–‡ç‰ˆå‰ç«¯éœæ…‹æª”æ¡ˆ
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ assets/
â”‚
â””â”€â”€ refill-bot/                 # ä¸­æ–‡ç‰ˆå‰ç«¯éœæ…‹æª”æ¡ˆ
    â”œâ”€â”€ index.html
    â””â”€â”€ assets/

/etc/systemd/system/
â”œâ”€â”€ refill-bot-en.service       # è‹±æ–‡ç‰ˆæœå‹™
â””â”€â”€ refill-bot-zh.service       # ä¸­æ–‡ç‰ˆæœå‹™

==================================================
ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²è‹±æ–‡ç‰ˆï¼ˆ1458ï¼‰
==================================================

1. ä¸Šå‚³ ZIP æª”åˆ° VM
--------------------------------------------------
# åœ¨æœ¬åœ°é›»è…¦ï¼ˆWindowsï¼‰é€é GCP SSH ç¶²é ä¸Šå‚³
# æˆ–ä½¿ç”¨ SCP/SFTP ä¸Šå‚³ wos_refill_bot_MULTISERVER_FINAL.zip

2. è§£å£“ç¸®åˆ°è‹±æ–‡ç‰ˆè³‡æ–™å¤¾
--------------------------------------------------
cd ~
unzip -o wos_refill_bot_MULTISERVER_FINAL.zip -d wos-english-refill-bot

3. é€²å…¥è‹±æ–‡ç‰ˆè³‡æ–™å¤¾
--------------------------------------------------
cd ~/wos-english-refill-bot
ls
# æ‡‰è©²çœ‹åˆ°ï¼šbot_refill.py, cogs/, panel/, utils/, ç­‰æª”æ¡ˆ

4. å»ºç«‹è‹±æ–‡ç‰ˆ .env
--------------------------------------------------
nano .env

# è¤‡è£½ä»¥ä¸‹å…§å®¹ä¸¦ä¿®æ”¹ï¼š
DISCORD_TOKEN=ä½ çš„è‹±æ–‡ç‰ˆDiscord_Bot_Token
GUILD_ALLOWLIST=1398071974692913324
COUNTER_ROLE_IDS=
COUNTER_ROLE_NAME=Annaway_Counter
TARGET_TEXT_CHANNEL_IDS=1398071974692913324:ä½ è¦é¡¯ç¤ºrefillå¡ç‰‡çš„é »é“ID
PANEL_URL=https://tools.annaway.com.tw/wos/counter-bot/1458/
PORT=8001

# æŒ‰ Ctrl+O å­˜æª”ï¼ŒEnter ç¢ºèªï¼ŒCtrl+X é›¢é–‹

5. å®‰è£ Python ä¾è³´ï¼ˆå¦‚æœé‚„æ²’è£éï¼‰
--------------------------------------------------
pip3 install -r requirements_refill.txt

6. å»ºç½®è‹±æ–‡ç‰ˆå‰ç«¯
--------------------------------------------------
cd ~/wos-english-refill-bot/panel/frontend

# æ¸…ç†èˆŠæª”æ¡ˆï¼ˆé¿å…æ¬Šé™å•é¡Œï¼‰
sudo rm -rf node_modules package-lock.json
npm cache clean --force

# å®‰è£ä¸¦å»ºç½®
npm install
npm run build

# ç¢ºèªå»ºç½®æˆåŠŸï¼ˆæ‡‰è©²çœ‹åˆ° dist è³‡æ–™å¤¾ï¼‰
ls -la dist/

7. éƒ¨ç½²è‹±æ–‡ç‰ˆå‰ç«¯åˆ° Nginx
--------------------------------------------------
cd ~/wos-english-refill-bot
sudo mkdir -p /var/www/refill-bot-en
sudo rm -rf /var/www/refill-bot-en/*
sudo cp -r panel/frontend/dist/* /var/www/refill-bot-en/

# ç¢ºèªæª”æ¡ˆå·²è¤‡è£½
ls -la /var/www/refill-bot-en/

8. å»ºç«‹æˆ–æ›´æ–° systemd æœå‹™ï¼ˆè‹±æ–‡ç‰ˆï¼‰
--------------------------------------------------
sudo nano /etc/systemd/system/refill-bot-en.service

# ç¢ºä¿å…§å®¹å¦‚ä¸‹ï¼š
[Unit]
Description=WOS Refill Timer Bot (English Version)
After=network.target

[Service]
Type=simple
User=anna_c
WorkingDirectory=/home/anna_c/wos-english-refill-bot
ExecStart=/usr/bin/python3 bot_refill.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

# Ctrl+O å­˜æª”ï¼ŒEnter ç¢ºèªï¼ŒCtrl+X é›¢é–‹

9. å•Ÿå‹•è‹±æ–‡ç‰ˆæœå‹™
--------------------------------------------------
sudo systemctl daemon-reload
sudo systemctl enable refill-bot-en
sudo systemctl restart refill-bot-en

# æŸ¥çœ‹ç‹€æ…‹
sudo systemctl status refill-bot-en

# æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u refill-bot-en -n 30 --no-pager

==================================================
ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²ä¸­æ–‡ç‰ˆï¼ˆ1496ï¼‰
==================================================

1. åœ¨æœ¬åœ°ä¿®æ”¹ vite.config.tsï¼ˆæº–å‚™ä¸­æ–‡ç‰ˆï¼‰
--------------------------------------------------
# åœ¨ä½ çš„ Windows é›»è…¦ä¸Š
# ç·¨è¼¯ F:\AnnawayProjects\wos_english_count_bot\panel\frontend\vite.config.ts

æ‰¾åˆ°ï¼š
  base: '/wos/counter-bot/1458/',

æ”¹æˆï¼š
  base: '/wos/counter-bot/1496/',

æ‰¾åˆ°ï¼š
  proxy: {
    '/api': {
      target: 'http://localhost:8001',

æ”¹æˆï¼š
      target: 'http://localhost:8000',

æ‰¾åˆ°ï¼š
    '/ws': {
      target: 'ws://localhost:8001',

æ”¹æˆï¼š
      target: 'ws://localhost:8000',

å­˜æª”ï¼

2. æ‰“åŒ…ä¸­æ–‡ç‰ˆ
--------------------------------------------------
# åœ¨ Windows PowerShell
cd F:\AnnawayProjects\wos_english_count_bot
Compress-Archive -Path * -DestinationPath wos_refill_bot_CHINESE_1496.zip -Force

# é€™æœƒç”¢ç”Ÿ wos_refill_bot_CHINESE_1496.zip

3. ä¸Šå‚³ä¸­æ–‡ç‰ˆ ZIP åˆ° VM
--------------------------------------------------
# é€é GCP SSH ç¶²é ä»‹é¢ä¸Šå‚³ wos_refill_bot_CHINESE_1496.zip

4. åœ¨ VM ä¸Šè§£å£“ç¸®ä¸­æ–‡ç‰ˆ
--------------------------------------------------
cd ~
unzip -o wos_refill_bot_CHINESE_1496.zip -d wos-chinese-refill-bot

5. å»ºç«‹ä¸­æ–‡ç‰ˆ .env
--------------------------------------------------
cd ~/wos-chinese-refill-bot
nano .env

# è¤‡è£½ä»¥ä¸‹å…§å®¹ä¸¦ä¿®æ”¹ï¼š
DISCORD_TOKEN=ä½ çš„ä¸­æ–‡ç‰ˆDiscord_Bot_Token
GUILD_ALLOWLIST=1354505516193419454
COUNTER_ROLE_IDS=
COUNTER_ROLE_NAME=Annaway_Counter
TARGET_TEXT_CHANNEL_IDS=1354505516193419454:ä½ è¦é¡¯ç¤ºrefillå¡ç‰‡çš„é »é“ID
PANEL_URL=https://tools.annaway.com.tw/wos/counter-bot/1496/
PORT=8000

# Ctrl+O å­˜æª”ï¼ŒEnter ç¢ºèªï¼ŒCtrl+X é›¢é–‹

6. å»ºç½®ä¸­æ–‡ç‰ˆå‰ç«¯
--------------------------------------------------
cd ~/wos-chinese-refill-bot/panel/frontend

# æ¸…ç†ä¸¦å»ºç½®
sudo rm -rf node_modules package-lock.json
npm cache clean --force
npm install
npm run build

# ç¢ºèªå»ºç½®æˆåŠŸ
ls -la dist/

7. éƒ¨ç½²ä¸­æ–‡ç‰ˆå‰ç«¯åˆ° Nginx
--------------------------------------------------
cd ~/wos-chinese-refill-bot
sudo mkdir -p /var/www/refill-bot
sudo rm -rf /var/www/refill-bot/*
sudo cp -r panel/frontend/dist/* /var/www/refill-bot/

# ç¢ºèªæª”æ¡ˆå·²è¤‡è£½
ls -la /var/www/refill-bot/

8. å»ºç«‹ systemd æœå‹™ï¼ˆä¸­æ–‡ç‰ˆï¼‰
--------------------------------------------------
sudo nano /etc/systemd/system/refill-bot-zh.service

# å…§å®¹ï¼š
[Unit]
Description=WOS Refill Timer Bot (Chinese Version)
After=network.target

[Service]
Type=simple
User=anna_c
WorkingDirectory=/home/anna_c/wos-chinese-refill-bot
ExecStart=/usr/bin/python3 bot_refill.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

# Ctrl+O å­˜æª”ï¼ŒEnter ç¢ºèªï¼ŒCtrl+X é›¢é–‹

9. å•Ÿå‹•ä¸­æ–‡ç‰ˆæœå‹™
--------------------------------------------------
sudo systemctl daemon-reload
sudo systemctl enable refill-bot-zh
sudo systemctl start refill-bot-zh

# æŸ¥çœ‹ç‹€æ…‹
sudo systemctl status refill-bot-zh

# æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u refill-bot-zh -n 30 --no-pager

==================================================
ç¬¬ä¸‰æ­¥ï¼šè¨­å®š Nginxï¼ˆåŒæ™‚æ”¯æ´å…©å€‹ç‰ˆæœ¬ï¼‰
==================================================

1. ç·¨è¼¯ Nginx è¨­å®š
--------------------------------------------------
sudo nano /etc/nginx/sites-available/refill-bot

# ç¢ºä¿åŒ…å«ä»¥ä¸‹å®Œæ•´å…§å®¹ï¼š
server {
    listen 80;
    server_name tools.annaway.com.tw;

    # ==========================================
    # English Version (1458)
    # ==========================================
    
    location /wos/counter-bot/1458/ {
        alias /var/www/refill-bot-en/;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /wos/counter-bot/1458/api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /wos/counter-bot/1458/ws {
        proxy_pass http://127.0.0.1:8001/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ==========================================
    # Chinese Version (1496)
    # ==========================================
    
    location /wos/counter-bot/1496/ {
        alias /var/www/refill-bot/;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /wos/counter-bot/1496/api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /wos/counter-bot/1496/ws {
        proxy_pass http://127.0.0.1:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# Ctrl+O å­˜æª”ï¼ŒEnter ç¢ºèªï¼ŒCtrl+X é›¢é–‹

2. æ¸¬è©¦ä¸¦é‡å•Ÿ Nginx
--------------------------------------------------
sudo nginx -t
sudo systemctl restart nginx

==================================================
ç¬¬å››æ­¥ï¼šé©—è­‰éƒ¨ç½²
==================================================

1. æª¢æŸ¥å…©å€‹æœå‹™éƒ½åœ¨é‹è¡Œ
--------------------------------------------------
sudo systemctl status refill-bot-en
sudo systemctl status refill-bot-zh

# éƒ½æ‡‰è©²é¡¯ç¤º "active (running)"

2. æª¢æŸ¥ Port ä½”ç”¨
--------------------------------------------------
sudo netstat -tlnp | grep -E "8000|8001"

# æ‡‰è©²çœ‹åˆ°ï¼š
# 8000 è¢« refill-bot-zh ä½¿ç”¨
# 8001 è¢« refill-bot-en ä½¿ç”¨

3. æ¸¬è©¦ Web é¢æ¿
--------------------------------------------------
# åœ¨ç€è¦½å™¨æ‰“é–‹ï¼š
# è‹±æ–‡ç‰ˆï¼šhttps://tools.annaway.com.tw/wos/counter-bot/1458/
# ä¸­æ–‡ç‰ˆï¼šhttps://tools.annaway.com.tw/wos/counter-bot/1496/

4. æ¸¬è©¦ Discord æŒ‡ä»¤
--------------------------------------------------
# åœ¨è‹±æ–‡ Discord ä¼ºæœå™¨è¼¸å…¥ï¼š/counter æˆ– /refill
# åœ¨ä¸­æ–‡ Discord ä¼ºæœå™¨è¼¸å…¥ï¼š/counter æˆ– /refill

# å…©é‚Šæ‡‰è©²éƒ½èƒ½æ­£å¸¸é‹ä½œï¼Œä¸”è¨ˆæ™‚å™¨ä¸æœƒæ··åœ¨ä¸€èµ·

==================================================
æ—¥å¸¸ç®¡ç†æŒ‡ä»¤
==================================================

# é‡å•Ÿæœå‹™
sudo systemctl restart refill-bot-en   # é‡å•Ÿè‹±æ–‡ç‰ˆ
sudo systemctl restart refill-bot-zh   # é‡å•Ÿä¸­æ–‡ç‰ˆ

# æŸ¥çœ‹æ—¥èªŒ
sudo journalctl -u refill-bot-en -f    # å³æ™‚æŸ¥çœ‹è‹±æ–‡ç‰ˆæ—¥èªŒ
sudo journalctl -u refill-bot-zh -f    # å³æ™‚æŸ¥çœ‹ä¸­æ–‡ç‰ˆæ—¥èªŒ

# åœæ­¢æœå‹™
sudo systemctl stop refill-bot-en
sudo systemctl stop refill-bot-zh

# æŸ¥çœ‹æ‰€æœ‰ refill-bot ç›¸é—œæœå‹™
sudo systemctl status refill-bot-*

==================================================
æ•…éšœæ’é™¤
==================================================

Q: Port è¢«ä½”ç”¨æ€éº¼è¾¦ï¼Ÿ
A: sudo netstat -tlnp | grep 8001
   æ‰¾åˆ° PID å¾Œï¼šsudo kill -9 <PID>
   ç„¶å¾Œé‡å•Ÿæœå‹™

Q: Nginx 403 éŒ¯èª¤ï¼Ÿ
A: æª¢æŸ¥æª”æ¡ˆæ¬Šé™ï¼š
   ls -la /var/www/refill-bot-en/
   ls -la /var/www/refill-bot/
   ç¢ºä¿æœ‰ index.html å’Œ assets è³‡æ–™å¤¾

Q: Discord æŒ‡ä»¤çœ‹ä¸åˆ°ï¼Ÿ
A: 1. æª¢æŸ¥ .env çš„ GUILD_ALLOWLIST æ˜¯å¦æ­£ç¢º
   2. æŸ¥çœ‹æ—¥èªŒç¢ºèªæœ‰ "Synced X slash commands"
   3. åœ¨ Discord Developer Portal é‡æ–°æˆæ¬Š Bot

Q: è¨ˆæ™‚å™¨æ··åœ¨ä¸€èµ·ï¼Ÿ
A: ç¢ºèªå…©å€‹ç‰ˆæœ¬ä½¿ç”¨ **ä¸åŒçš„ Discord Token**
   é€™æ˜¯æœ€é‡è¦çš„éš”é›¢æ©Ÿåˆ¶ï¼

